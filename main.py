import chainlit as cl
from fastapi.middleware.cors import CORSMiddleware
from fastapi import FastAPI

allowed_ports = [3000, 5173]
allow_origins = [f"http://localhost:{port}" for port in allowed_ports] + \
                [f"http://127.0.0.1:{port}" for port in allowed_ports]

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=allow_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Add proper CORS settings to allow frontend access with credentials


import google.generativeai as genai
from typing import Optional, Dict, List
import re
import asyncio
from datetime import datetime
import json

# Configure Gemini
genai.configure(api_key="AIzaSyCNQF9HwY19SVbmErBNNJ9RxG7KgDaNE8M")  # Replace with your actual API key
model = genai.GenerativeModel("gemini-1.5-flash")

# Bot Configuration
BOT_NAME = "ShopMate"
BOT_EMOJI = "üõí"

# Enhanced Product Analysis Prompts
def generate_product_description_prompt(product_name: str) -> str:
    """Generate a comprehensive product description prompt"""
    return f"""
You are ShopMate, a professional shopping assistant like a Flipkart expert. Create a detailed product description for: "{product_name}".

Format your response EXACTLY as follows:

üéØ PRODUCT OVERVIEW:
Write a compelling 3-4 sentence introduction about the product that highlights its main appeal and market position.

‚≠ê KEY FEATURES & SPECIFICATIONS:
‚Ä¢ Primary feature with specific details and emoji
‚Ä¢ Technical specification with numbers/details and emoji
‚Ä¢ Unique selling point with emoji
‚Ä¢ Performance/quality aspect with emoji
‚Ä¢ Design/build quality with emoji

‚úÖ MAJOR ADVANTAGES:
‚Ä¢ Advantage 1 with detailed explanation
‚Ä¢ Advantage 2 with detailed explanation
‚Ä¢ Advantage 3 with detailed explanation
‚Ä¢ Advantage 4 with detailed explanation

‚ùå POTENTIAL DRAWBACKS:
‚Ä¢ Limitation 1 with context
‚Ä¢ Limitation 2 with context
‚Ä¢ Limitation 3 with context

üí∞ PRICING & VALUE:
‚Ä¢ Price Range: ‚Çπ[X,XXX - Y,XXX] (Current Indian market)
‚Ä¢ Value Proposition: [Explain if it's worth the price]
‚Ä¢ Best Deals: [Mention where to find best prices]

üë• IDEAL FOR:
‚Ä¢ [Target audience 1] - [Why it's perfect for them]
‚Ä¢ [Target audience 2] - [Why it's perfect for them]
‚Ä¢ [Target audience 3] - [Why it's perfect for them]

üåü EXPERT RATING: [X.X/5.0] ‚≠ê
Verdict: [2-3 sentence summary of overall recommendation]

Keep it comprehensive yet under 400 words. Use specific details and avoid generic statements.
"""

def generate_product_suggestion_prompt(user_requirements: str) -> str:
    """Generate personalized product suggestions based on user requirements"""
    return f"""
You are ShopMate, acting like a professional Flipkart sales expert. Based on these requirements: "{user_requirements}", suggest 4 specific real products with detailed analysis.

Format your response EXACTLY as follows:

üéØ UNDERSTANDING YOUR NEEDS:
[Summarize what the user is looking for in 2-3 sentences]

üí° MY TOP RECOMMENDATIONS:

## 1. ü•á [Brand + Full Product Name]
üí∞ Price: ‚Çπ[X,XXX - Y,XXX]
‚≠ê Rating: [X.X/5] ([Y,XXX+ reviews])
üéØ Perfect Match Because: [Explain why this fits their needs]
üî• Best Feature: [Highlight the standout feature]
üì¶ Availability: [Stock status and delivery info]

## 2. ü•à [Brand + Full Product Name]
üí∞ Price: ‚Çπ[X,XXX - Y,XXX]
‚≠ê Rating: [X.X/5] ([Y,XXX+ reviews])
üéØ Perfect Match Because: [Explain why this fits their needs]
üî• Best Feature: [Highlight the standout feature]
üì¶ Availability: [Stock status and delivery info]

## 3. ü•â [Brand + Full Product Name]
üí∞ Price: ‚Çπ[X,XXX - Y,XXX]
‚≠ê Rating: [X.X/5] ([Y,XXX+ reviews])
üéØ Perfect Match Because: [Explain why this fits their needs]
üî• Best Feature: [Highlight the standout feature]
üì¶ Availability: [Stock status and delivery info]

## 4. üíé [Brand + Full Product Name] (Premium Choice)
üí∞ Price: ‚Çπ[X,XXX - Y,XXX]
‚≠ê Rating: [X.X/5] ([Y,XXX+ reviews])
üéØ Perfect Match Because: [Explain why this fits their needs]
üî• Best Feature: [Highlight the standout feature]
üì¶ Availability: [Stock status and delivery info]

---

üèÜ MY PERSONAL RECOMMENDATION:
Based on your requirements, I'd personally recommend [Product Name] because [detailed reasoning].

üõí NEXT STEPS:
1. Compare these options in detail
2. Check current offers and discounts
3. Read recent customer reviews
4. Consider extended warranty options

Keep under 500 words with real, currently available products.
"""

def generate_comparison_prompt(product1: str, product2: str) -> str:
    """Generate comprehensive product comparison with visual elements"""
    return f"""
You are ShopMate, a professional product comparison expert. Create a detailed comparison between "{product1}" and "{product2}".

Format your response EXACTLY as follows:

# ü•ä {product1} vs {product2}

## üèÜ QUICK VERDICT
Winner: {product1} / {product2} / It's a tie!
Reason: [1-2 sentence explanation]

## üìä DETAILED COMPARISON

### üí∞ PRICING
| Aspect | {product1} | {product2} |
|--------|-------------|-------------|
| Current Price | ‚Çπ[X,XXX] | ‚Çπ[X,XXX] |
| Value Rating | [X/10] ‚≠ê | [X/10] ‚≠ê |
| Best Deals | [Platform/offer] | [Platform/offer] |

### üîß SPECIFICATIONS & PERFORMANCE
| Feature | {product1} | {product2} |
|---------|-------------|-------------|
| Key Spec 1 | [Details] | [Details] |
| Key Spec 2 | [Details] | [Details] |
| Performance | [Rating/10] | [Rating/10] |
| Build Quality | [Rating/10] | [Rating/10] |

### üë• USER EXPERIENCE
| Aspect | {product1} | {product2} |
|--------|-------------|-------------|
| Ease of Use | [Rating/10] | [Rating/10] |
| Customer Rating | [X.X/5] ([Y,XXX reviews]) | [X.X/5] ([Y,XXX reviews]) |
| After-Sales | [Rating/10] | [Rating/10] |

## üéØ DETAILED ANALYSIS

### üü¢ {product1} - STRENGTHS
‚Ä¢ [Strength 1 with explanation]
‚Ä¢ [Strength 2 with explanation]
‚Ä¢ [Strength 3 with explanation]

### üî¥ {product1} - WEAKNESSES
‚Ä¢ [Weakness 1 with context]
‚Ä¢ [Weakness 2 with context]

### üü¢ {product2} - STRENGTHS
‚Ä¢ [Strength 1 with explanation]
‚Ä¢ [Strength 2 with explanation]
‚Ä¢ [Strength 3 with explanation]

### üî¥ {product2} - WEAKNESSES
‚Ä¢ [Weakness 1 with context]
‚Ä¢ [Weakness 2 with context]

## üéØ PERSONALIZED RECOMMENDATIONS

Choose {product1} if you:
‚Ä¢ [Scenario 1]
‚Ä¢ [Scenario 2]
‚Ä¢ [Scenario 3]

Choose {product2} if you:
‚Ä¢ [Scenario 1]
‚Ä¢ [Scenario 2]
‚Ä¢ [Scenario 3]

## üìà FINAL SCORE BREAKDOWN

Overall Performance: {product1} [X/10] | {product2} [X/10]
Value for Money:     {product1} [X/10] | {product2} [X/10]
User Experience:     {product1} [X/10] | {product2} [X/10]
Future-Proofing:     {product1} [X/10] | {product2} [X/10]

üèÜ FINAL RECOMMENDATION:
[Detailed 2-3 sentence recommendation based on analysis]

Keep under 600 words with accurate, helpful comparisons.
"""

# Enhanced Follow-up Button Functions

def create_main_action_buttons():
    """Create main action buttons with Flipkart styling"""
    return [
        cl.Action(
            name="describe",
            value="describe",
            payload={"action": "describe"},
            description="Get detailed product information",
            label="üì± Product Description"
        ),
        cl.Action(
            name="suggest",
            value="suggest",
            payload={"action": "suggest"},
            description="Get personalized product suggestions",
            label="üéØ Product Suggestions"
        ),
        cl.Action(
            name="compare",
            value="compare",
            payload={"action": "compare"},
            description="Compare two products",
            label="‚öñ Product Comparison"
        )
    ]

def create_description_followup_buttons(product_name: str):
    """Create follow-up buttons for product description"""
    return [
        cl.Action(
            name="detailed_specs",
            value=f"detailed_specs_{product_name}",
            payload={"action": "detailed_specs", "product": product_name},
            description="Get technical specifications",
            label="üîß Detailed Specs"
        ),
        cl.Action(
            name="user_reviews",
            value=f"user_reviews_{product_name}",
            payload={"action": "user_reviews", "product": product_name},
            description="See what users say",
            label="‚≠ê User Reviews"
        ),
        cl.Action(
            name="alternatives",
            value=f"alternatives_{product_name}",
            payload={"action": "alternatives", "product": product_name},
            description="Find similar products",
            label="üîç Alternatives"
        ),
        cl.Action(
            name="best_deals",
            value=f"best_deals_{product_name}",
            payload={"action": "best_deals", "product": product_name},
            description="Find best prices",
            label="üí∞ Best Deals"
        )
    ]

def create_suggestion_followup_buttons():
    """Create follow-up buttons for product suggestions"""
    return [
        cl.Action(
            name="compare_suggestions",
            value="compare_suggestions",
            payload={"action": "compare_suggestions"},
            description="Compare suggested products",
            label="‚öñ Compare These"
        ),
        cl.Action(
            name="refine_search",
            value="refine_search",
            payload={"action": "refine_search"},
            description="Refine your requirements",
            label="üéØ Refine Search"
        ),
        cl.Action(
            name="budget_options",
            value="budget_options",
            payload={"action": "budget_options"},
            description="Show budget alternatives",
            label="üí∏ Budget Options"
        ),
        cl.Action(
            name="premium_options",
            value="premium_options",
            payload={"action": "premium_options"},
            description="Show premium alternatives",
            label="üíé Premium Options"
        )
    ]

def create_comparison_followup_buttons():
    """Create follow-up buttons for product comparison"""
    return [
        cl.Action(
            name="detailed_comparison",
            value="detailed_comparison",
            payload={"action": "detailed_comparison"},
            description="Get more detailed analysis",
            label="üîç Deeper Analysis"
        ),
        cl.Action(
            name="pros_cons",
            value="pros_cons",
            payload={"action": "pros_cons"},
            description="Detailed pros and cons",
            label="‚úÖ‚ùå Pros & Cons"
        ),
        cl.Action(
            name="similar_comparisons",
            value="similar_comparisons",
            payload={"action": "similar_comparisons"},
            description="Compare with other products",
            label="üîÑ More Comparisons"
        )
    ]

# Session Management
class ChatSession:
    def __init__(self):
        self.mode = None
        self.comparison_product1 = None
        self.last_product = None
        self.last_suggestions = []
        self.user_preferences = {}
    
    def set_mode(self, mode: str):
        self.mode = mode
    
    def get_mode(self):
        return self.mode
    
    def reset_mode(self):
        self.mode = None
        self.comparison_product1 = None

# Enhanced Follow-up Handlers
def generate_detailed_specs_prompt(product_name: str) -> str:
    """Generate detailed specifications prompt"""
    return f"""
You are ShopMate. Provide comprehensive technical specifications for: "{product_name}".

Format as:
## üîß Detailed Specifications - {product_name}

üìê DIMENSIONS & BUILD:
‚Ä¢ Size: [dimensions]
‚Ä¢ Weight: [weight]
‚Ä¢ Material: [material details]
‚Ä¢ Colors: [available colors]

‚ö° PERFORMANCE SPECS:
‚Ä¢ [Key performance metrics with numbers]
‚Ä¢ [Processing/speed details]
‚Ä¢ [Capacity/storage details]
‚Ä¢ [Battery/power details if applicable]

üîå CONNECTIVITY & FEATURES:
‚Ä¢ [Connection options]
‚Ä¢ [Special features]
‚Ä¢ [Compatibility info]

üì¶ PACKAGE CONTENTS:
‚Ä¢ [What's included in the box]

üõ° WARRANTY & SUPPORT:
‚Ä¢ [Warranty information]
‚Ä¢ [Service support details]

Keep detailed but under 300 words.
"""

def generate_user_reviews_prompt(product_name: str) -> str:
    """Generate user reviews summary prompt"""
    return f"""
You are ShopMate. Summarize user reviews and feedback for: "{product_name}".

Format as:
## ‚≠ê User Reviews Summary - {product_name}

üìä OVERALL RATING: [X.X/5] based on [X,XXX+] reviews

üëç WHAT USERS LOVE:
‚Ä¢ [Most praised feature 1] - "[Sample positive quote]"
‚Ä¢ [Most praised feature 2] - "[Sample positive quote]"
‚Ä¢ [Most praised feature 3] - "[Sample positive quote]"

üëé COMMON COMPLAINTS:
‚Ä¢ [Common issue 1] - "[Sample negative quote]"
‚Ä¢ [Common issue 2] - "[Sample negative quote]"

üí° USER TIPS:
‚Ä¢ [Helpful tip from users 1]
‚Ä¢ [Helpful tip from users 2]

üéØ VERDICT FROM REAL USERS:
[2-3 sentence summary of overall user sentiment]

Keep realistic and balanced, under 250 words.
"""

def generate_best_deals_prompt(product_name: str) -> str:
    """Generate best deals prompt"""
    return f"""
You are ShopMate. Find the best deals and offers for: "{product_name}".

Format as:
## üí∞ Best Deals - {product_name}

üî• CURRENT BEST OFFERS:
‚Ä¢ Flipkart: ‚Çπ[X,XXX] - [Special offer/discount]
‚Ä¢ Amazon: ‚Çπ[X,XXX] - [Special offer/discount]  
‚Ä¢ Other Platform: ‚Çπ[X,XXX] - [Special offer/discount]

üí≥ PAYMENT OFFERS:
‚Ä¢ [Bank offer 1]
‚Ä¢ [Credit card offer]
‚Ä¢ [EMI options]

üéÅ BUNDLE DEALS:
‚Ä¢ [Bundle option 1]
‚Ä¢ [Bundle option 2]

üìÖ UPCOMING SALES:
‚Ä¢ [Next sale event and expected discount]

üí° MONEY-SAVING TIPS:
‚Ä¢ [Tip 1 for getting best price]
‚Ä¢ [Tip 2 for getting best price]

üèÜ RECOMMENDED PURCHASE:
Buy from [Platform] at ‚Çπ[X,XXX] because [reason].

Keep practical and actionable, under 200 words.
"""

# Main Chat Functions
@cl.on_chat_start
async def start():
    """Initialize chat with clean Flipkart-themed welcome"""
    # Initialize session
    cl.user_session.set("chat_session", ChatSession())
    
    welcome_msg = f"""# üõí Welcome to {BOT_NAME}
Your AI Shopping Assistant - Powered by Flipkart Intelligence

## üéØ How I Can Help You:

üì± Product Descriptions: Get detailed insights about any product
üéØ Smart Suggestions: Find products based on your needs & budget  
‚öñ Product Comparisons: Compare products with detailed analysis

---

Choose an option below to get started! üëá
"""
    
    await cl.Message(
        content=welcome_msg,
        actions=create_main_action_buttons()
    ).send()

# Enhanced Action Handlers
@cl.action_callback("describe")
async def on_describe_action(action):
    """Handle product description requests"""
    session = cl.user_session.get("chat_session")
    session.set_mode("describe")
    
    msg = """
## üì± Product Description Service

Just type the name of any product and I'll provide you with:
- Comprehensive overview and key features
- Detailed pros and cons analysis  
- Pricing information and value assessment
- Target audience recommendations
- Expert rating and verdict

Example: "iPhone 15 Pro", "Samsung Galaxy S24", "MacBook Air M2"
"""
    await cl.Message(content=msg, actions=create_main_action_buttons()).send()

@cl.action_callback("suggest")
async def on_suggest_action(action):
    """Handle product suggestion requests"""
    session = cl.user_session.get("chat_session")
    session.set_mode("suggest")
    
    msg = """
## üéØ Product Suggestion Service

Tell me what you're looking for and I'll suggest the best products for you!

Include details like:
- What type of product you need
- Your budget range
- Specific requirements or preferences
- Intended use case

Example: "Gaming laptop under ‚Çπ80,000", "Smartphone with good camera under ‚Çπ25,000", "Wireless earbuds for gym"
"""
    await cl.Message(content=msg, actions=create_main_action_buttons()).send()

@cl.action_callback("compare")
async def on_compare_action(action):
    """Handle product comparison requests"""
    session = cl.user_session.get("chat_session")
    session.set_mode("compare")
    
    msg = """
## ‚öñ Product Comparison Service

I'll help you compare two products with:
- Detailed specification comparison
- Performance analysis with ratings
- Pros and cons breakdown
- Personalized recommendations
- Final verdict with scoring

Enter the first product you want to compare:
"""
    await cl.Message(content=msg, actions=create_main_action_buttons()).send()

# Enhanced Follow-up Action Handlers
@cl.action_callback("detailed_specs")
async def on_detailed_specs_action(action):
    """Handle detailed specifications request"""
    # Extract product name from action value
    product_name = action.value.replace("detailed_specs_", "")
    await process_followup_query("detailed_specs", product_name)

@cl.action_callback("user_reviews")
async def on_user_reviews_action(action):
    """Handle user reviews request"""
    # Extract product name from action value
    product_name = action.value.replace("user_reviews_", "")
    await process_followup_query("user_reviews", product_name)

@cl.action_callback("alternatives")
async def on_alternatives_action(action):
    """Handle alternatives request"""
    # Extract product name from action value
    product_name = action.value.replace("alternatives_", "")
    session = cl.user_session.get("chat_session")
    session.set_mode("suggest")
    await process_product_query(f"alternatives to {product_name}")

@cl.action_callback("best_deals")
async def on_best_deals_action(action):
    """Handle best deals request"""
    # Extract product name from action value
    product_name = action.value.replace("best_deals_", "")
    await process_followup_query("best_deals", product_name)

# Additional follow-up handlers for suggestion buttons
@cl.action_callback("compare_suggestions")
async def on_compare_suggestions_action(action):
    """Handle compare suggestions request"""
    session = cl.user_session.get("chat_session")
    session.set_mode("compare")
    
    msg = """
### ‚öñ Compare Products
Enter the first product you want to compare:
"""
    await cl.Message(content=msg, actions=create_main_action_buttons()).send()

@cl.action_callback("refine_search")
async def on_refine_search_action(action):
    """Handle refine search request"""
    session = cl.user_session.get("chat_session")
    session.set_mode("suggest")
    
    msg = """
### üéØ Refine Your Search
Tell me more specific requirements:
- Preferred brand or features
- Exact budget range
- Specific use case or needs
"""
    await cl.Message(content=msg, actions=create_main_action_buttons()).send()

@cl.action_callback("budget_options")
async def on_budget_options_action(action):
    """Handle budget options request"""
    session = cl.user_session.get("chat_session")
    session.set_mode("suggest")
    
    msg = """
### üí∏ Budget Options
What's your budget range and what type of product are you looking for?
"""
    await cl.Message(content=msg, actions=create_main_action_buttons()).send()

@cl.action_callback("premium_options")
async def on_premium_options_action(action):
    """Handle premium options request"""
    session = cl.user_session.get("chat_session")
    session.set_mode("suggest")
    
    msg = """
### üíé Premium Options
What premium product are you looking for? I'll show you the best high-end options!
"""
    await cl.Message(content=msg, actions=create_main_action_buttons()).send()

# Core Processing Functions
async def process_followup_query(query_type: str, product_name: str):
    """Process follow-up queries"""
    msg = cl.Message(content="üîç Getting detailed information...")
    await msg.send()
    try:
        if query_type == "detailed_specs":
            prompt = generate_detailed_specs_prompt(product_name)
        elif query_type == "user_reviews":
            prompt = generate_user_reviews_prompt(product_name)
        elif query_type == "best_deals":
            prompt = generate_best_deals_prompt(product_name)
        else:
            raise ValueError(f"Unknown query type: {query_type}")
        response = model.generate_content(prompt)
        await msg.update(response.text)
        await cl.Message(
            content="Need more help? üëá",
            actions=create_main_action_buttons()
        ).send()
    except Exception as e:
        await msg.update("üòÖ Sorry, I couldn't process that request. Please try again with a different product or be more specific!")
        await cl.Message(
            content="Let's try something else! üëá",
            actions=create_main_action_buttons()
        ).send()

async def process_product_query(user_input: str):
    """Process product queries with enhanced error handling"""
    session = cl.user_session.get("chat_session")
    mode = session.get_mode()
    
    # Show loading message
    msg = cl.Message(content="üîç Analyzing products...")
    await msg.send()
    
    try:
        # Generate response based on mode
        if mode == "describe":
            prompt = generate_product_description_prompt(user_input)
            session.last_product = user_input
        elif mode == "suggest":
            prompt = generate_product_suggestion_prompt(user_input)
        elif mode == "compare":
            if not session.comparison_product1:
                session.comparison_product1 = user_input
                msg.content = f"‚úÖ First product: {user_input}\n\nüìù Now enter the second product to compare:"
                await msg.update()

                return
            else:
                prompt = generate_comparison_prompt(session.comparison_product1, user_input)
        else:
            # Default to description
            prompt = generate_product_description_prompt(user_input)
            session.last_product = user_input
        
        # Get response from Gemini
        response = model.generate_content(prompt)
        
        # Update with final response
        msg.content = response.text.strip()
        await msg.update()

        
        # Show appropriate follow-up buttons
        if mode == "describe":
            await cl.Message(
                content="Want to know more? üëá",
                actions=create_description_followup_buttons(session.last_product)
            ).send()
        elif mode == "suggest":
            await cl.Message(
                content="What would you like to do next? üëá",
                actions=create_suggestion_followup_buttons()
            ).send()
        elif mode == "compare":
            await cl.Message(
                content="Want more analysis? üëá",
                actions=create_comparison_followup_buttons()
            ).send()
        
        # Reset session
        session.reset_mode()
        
        # Show main buttons for next action
        await cl.Message(
            content="---\n*Start a new search?* üëá",
            actions=create_main_action_buttons()
        ).send()
        
    except Exception as e:
        msg.content= "üòÖ Sorry, I couldn't process that request. Please try again with a different product or be more specific!"
        await msg.update()
        session.reset_mode()
        await cl.Message(
            content="Let's try again! üëá",
            actions=create_main_action_buttons()
        ).send()

@cl.on_message
async def handle_message(message: cl.Message):
    """Enhanced message handling"""
    user_input = message.content.strip()
    session = cl.user_session.get("chat_session")
    
    # Handle empty input
    if not user_input:
        await cl.Message(
            content="Please tell me what you're looking for! üòä",
            actions=create_main_action_buttons()
        ).send()
        return
    
    # Handle greetings
    greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'thanks', 'thank you']
    if any(greeting in user_input.lower() for greeting in greetings):
        if 'thank' in user_input.lower():
            response = "You're welcome! üòä I'm always here to help you find the perfect products!"
        else:
            response = f"Hello! üëã I'm {BOT_NAME}, your AI shopping assistant! How can I help you find the perfect product today?"
        
        await cl.Message(
            content=response,
            actions=create_main_action_buttons()
        ).send()
        return
    
    # Handle cases where mode is not set - default to description
    if not session.get_mode():
        session.set_mode("describe")
    
    # Process the query
    await process_product_query(user_input)

if __name__ == "__main__":
    cl.run()